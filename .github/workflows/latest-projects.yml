name: Update Latest Projects

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-projects:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch latest repos
        id: repos
        uses: octokit/graphql-action@v2.x
        with:
          query: |
            {
              viewer {
                repositories(first: 5, orderBy: {field: CREATED_AT, direction: DESC}) {
                  nodes {
                    name
                    url
                    description
                  }
                }
              }
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Build project list
        id: build
        run: |
          echo "projects<<"EOF" >> $GITHUB_OUTPUT
          echo '${{ steps.repos.outputs.data }}' | jq -r '
            .viewer.repositories.nodes[] |
            "- [\(.name)](\(.url)) â€” \(.description // "No description")"
          '
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          sed -i "/<!-- LATEST_PROJECTS_START -->/,/<!-- LATEST_PROJECTS_END -->/c\\<!-- LATEST_PROJECTS_START -->\n${{ steps.build.outputs.projects }}\n<!-- LATEST_PROJECTS_END -->" README.md

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ðŸ”„ Update latest projects"
